#!/usr/bin/env php
<?php

function echo_error_and_die_if( $condition, $message ) {
	static $code = 0;

	$code++;

	if ( $condition ) {
		fwrite( STDERR, "\033[31m" . $message . "\033[0m" . PHP_EOL );
		exit( $code );
	}
}

echo_error_and_die_if(
	empty( $argv[1] ) || ! file_exists( $argv[1] ),
	'The commit message hasn\'t been found.'
);

$message = explode( PHP_EOL, file_get_contents( $argv[1] ) );
$message = array_filter( $message, function( $line ) { return preg_match( '/^[^#]+/', $line ); } );
$message = trim( implode( ' ', $message ) );
$first_word = current( explode( ' ', $message ) );

// message ends in a dot
echo_error_and_die_if(
	preg_match( '/[^\.]$/', $message ),
	'The commit message must end with a full stop.'
);

// message starts with a capital letter.
echo_error_and_die_if(
	! preg_match( '/^[A-Z][a-z-]*$/', $first_word ),
	'The commit message must start with a capital letter.'
);

// first word of the message does not end in "ed" or "es"
echo_error_and_die_if(
	preg_match( '/(ed|es)$/', $first_word ),
	'The commit message must start with a verb in present tense.'
);
